var http=function(){return{get:get};function get(url,query,callback){var req=new XMLHttpRequest;url+="?"+serialize(query);req.open("GET",url,true);req.setRequestHeader("Connection","close");req.onload=function(){if(req.readyState===4&&req.status===200){if(req.status===200){var response=JSON.parse(req.responseText);return callback(null,response)}}else{return callback(new Error(req.status))}};req.onerror=function(){switch(req.status){case 0:return callback(new Error("NOT_CONNECTED"));case 404:return callback(new Error("NOT_FOUND"))}};req.send();function serialize(obj){var str=[];for(var p in obj){if(obj.hasOwnProperty(p)){str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]))}}return str.join("&")}}}();var Analytics=function(analyticsId,appName,appVersion){this.analyticsId=analyticsId;this.appName=appName;this.appVersion=appVersion;this.analyticsUserId=Pebble.getAccountToken()};Analytics.prototype._trackGA=function(type,params){var req=new XMLHttpRequest;var url="http://www.google-analytics.com/collect";var trackingParams="v=1";trackingParams+="&tid="+this.analyticsId;trackingParams+="&cid="+this.analyticsUserId;trackingParams+="&t="+type;trackingParams+="&an="+this.appName;trackingParams+="&av="+this.appVersion;for(var parameterKey in params){if(params.hasOwnProperty(parameterKey)){trackingParams+="&"+parameterKey+"="+params[parameterKey]}}req.open("POST",url,true);req.setRequestHeader("Content-length",trackingParams.length);req.send(trackingParams)};Analytics.prototype.trackScreen=function(screenName){this._trackGA("appview",{cd:screenName})};Analytics.prototype.trackEvent=function(category,action){this._trackGA("event",{ec:category,ea:action})};var AppInfo={uuid:"00e9deeb-16b4-4752-ae35-2cc088fc6ca9",shortName:"UK Transport",longName:"UK Transport",companyName:"Matthew Tole",versionCode:8,versionLabel:"0.2.7",watchapp:{watchface:false},appKeys:{group:0,operation:1,data:2},capabilities:["location"],resources:{media:[{menuIcon:true,type:"png",name:"MENU_ICON",file:"images/menu.png"},{type:"png",name:"MENU_RAIL",file:"images/menu_rail.png"},{type:"png",name:"MENU_TFL",file:"images/menu_tfl.png"},{type:"png",name:"MENU_BUS",file:"images/menu_bus.png"},{type:"png",name:"MENU_REFRESH",file:"images/menu_refresh.png"},{type:"png",name:"MENU_SETTINGS",file:"images/menu_settings.png"},{type:"png",name:"MENU_ABOUT",file:"images/menu_about.png"}]}};var Config={transportApi:{apiKey:"19490bb45f53178a0b508d37569b9910",appId:"633e7987"},debug:false};var Bus=function(options){this.pebble=options.pebble;this.http=options.http;this.debug=options.debug;this.location=options.location;this.analytics=options.ga;this.transportApi=options.transportApi;this.version=options.version;this.pebbleAppMessage=function(event){var payload=event.payload;var group=payload.group.toLowerCase();if(group!=="bus"){return}if(this.debug){console.log("UK Transport // Bus // Payload // "+JSON.stringify(payload))}var operation=payload.operation.toLowerCase();switch(operation){case"stops":opBusStops.call(this,payload.data);break;case"departures":opBusDepartures.call(this,payload.data);break}};function opBusStops(){if(this.analytics){this.analytics.trackEvent("bus","stops")}this.location.getCurrentPosition(locationCallback.bind(this),locationError.bind(this));function locationCallback(position){var requestData={lon:position.coords.longitude,lat:position.coords.latitude,page:1,rpp:10,api_key:this.transportApi.apiKey,app_id:this.transportApi.appId};this.http.get("http://transportapi.com/v3/uk/bus/stops/near.json",requestData,requestCallback.bind(this))}function locationError(err){console.log(err)}function requestCallback(err,data){if(err){return console.log(err)}if(!data){return console.log(new Error("Lack of data!"))}var stops=data.stops;var responseData=[];responseData.push(stops.length);stops.forEach(function(stop){responseData.push(stop.atcocode);responseData.push(stop.name);responseData.push(stop.indicator)});this.pebble.sendAppMessage({group:"BUS",operation:"STOPS",data:responseData.join("|")})}}function opBusDepartures(data){if(this.analytics){this.analytics.trackEvent("bus","depatures-"+data)}var code=data;var requestData={api_key:this.transportApi.apiKey,app_id:this.transportApi.appId,group:"no"};this.http.get("http://transportapi.com/v3/uk/bus/stop/"+code+"/live.json",requestData,requestCallback.bind(this));function requestCallback(err,data){var departures=data.departures.all;var responseData=[];responseData.push(departures.length);departures.forEach(function(departure){responseData.push(departure.line);responseData.push(departure.direction);responseData.push(departure.best_departure_estimate)});this.pebble.sendAppMessage({group:"BUS",operation:"DEPARTURES",data:responseData.join("|")})}}};Bus.prototype.init=function(){this.pebble.addEventListener("appmessage",this.pebbleAppMessage.bind(this))};var Tube=function(options){this.pebble=options.pebble;this.http=options.http;this.debug=options.debug;this.analytics=options.ga;this.version=options.version};Tube.prototype._onPebbleAppMessage=function(event){var payload=event.payload;var group=payload.group.toLowerCase();if(group!=="tube"){return}if(this.debug){console.log("UK Transport // Tube // Payload // "+JSON.stringify(payload))}var operation=payload.operation.toLowerCase();switch(operation){case"update":opLineStatus.call(this,payload.data);break}function opLineStatus(data){if(this.analytics){this.analytics.trackEvent("tube","update")}var url="http://matthewtole.com/pebble/tube/";this.http.get(url,data,function(err,data){if(err){switch(err.message){case"NOT_CONNECTED":return this.pebble.sendAppMessage({group:"ERROR",operation:"HTTP",data:"OFFLINE"});default:return this.pebble.sendAppMessage({group:"ERROR",operation:"HTTP",data:"UNKNOWN"})}}if(!data||!data.response||!data.response.lines){if(this.debug){console.log("Response from tube update API was invalid.")}return}var lines=data.response.lines;lines=lines.map(function(line){var betterLine={name:line.name.replace("&amp;","&"),statuses:line.status.split(",")};betterLine.ok=betterLine.statuses[0]==="good service";betterLine.statuses=betterLine.statuses.map(function(str){return titleize(str.trim())});betterLine.statuses.sort(function(statusA,statusB){var orderA=Tube.StatusOrdering.indexOf(statusA);var orderB=Tube.StatusOrdering.indexOf(statusB);return orderA<orderB?-1:orderA>orderB?1:0});return betterLine});lines.sort(function(lineA,lineB){var weightA=statusWeight(lineA);var weightB=statusWeight(lineB);return weightA<weightB?1:weightA>weightB?-1:lineA.name.localeCompare(lineB.name)});lines=dedupeLines(lines);var updateData=[lines.length];lines.forEach(function(line){updateData.push(line.name);updateData.push(line.statuses.join(", "))});this.pebble.sendAppMessage({group:"TUBE",operation:"UPDATE",data:updateData.join("|")})}.bind(this))}function statusWeight(line){return line.statuses.reduce(function(weight,status){return weight+Math.pow(2,-1*Tube.StatusOrdering.indexOf(status))},0)}function dedupeLines(lines){var dedupedLines=[];lines.forEach(function(line){var existingLine=find(dedupedLines,function(innerLine){return line.name===innerLine.name});if(!existingLine){dedupedLines.push(line)}});return dedupedLines}function titleize(str){if(str===null){return""}str=String(str).toLowerCase();return str.replace(/(?:^|\s|-)\S/g,function(c){return c.toUpperCase()})}function find(array,callback){for(var i=0;i<array.length;i+=1){if(callback(array[i])){return array[i]}}return undefined}};Tube.prototype.init=function(){if(this.debug){console.log("UK Transport // "+this.version+" // Tube // Ready")}this.pebble.addEventListener("appmessage",this._onPebbleAppMessage.bind(this))};Tube.StatusOrdering=["Suspended","Part Suspended","Planned Closure","Part Closure","Severe Delays","Reduced Service","Bus Service","Minor Delays","Good Service"];var Train=function(options){this.pebble=options.pebble;this.http=options.http;this.debug=options.debug;this.location=options.location;this.analytics=options.ga;this.transportApi=options.transportApi;this.version=options.version;this.onPebbleAppMessage=function(event){var payload=event.payload;var group=payload.group.toLowerCase();if(group!=="train"){return}if(this.debug){console.log("UK Transport // Train // Payload // "+JSON.stringify(payload))}var operation=payload.operation.toLowerCase();switch(operation){case"stations":opTrainStations.call(this,payload.data);break;case"departures":opTrainDepartures.call(this,payload.data);break}};function opTrainStations(){if(this.analytics){this.analytics.trackEvent("train","stations")}var timeLocation=new Date;var timeLookup=null;var locationOptions={enableHighAccuracy:false,timeout:5*1e3,maximumAge:60*1e3};this.location.getCurrentPosition(locationCallback.bind(this),locationError.bind(this),locationOptions);function locationCallback(position){logTimeElapsed.call(this,timeLocation,"Getting location took %TIME%.");var requestData={lon:position.coords.longitude,lat:position.coords.latitude,page:1,rpp:10,api_key:this.transportApi.apiKey,app_id:this.transportApi.appId};timeLookup=new Date;this.http.get("http://transportapi.com/v3/uk/train/stations/near.json",requestData,requestCallback.bind(this))}function locationError(){logTimeElapsed.call(this,timeLocation,"Failing to get location took %TIME%.");this.pebble.sendAppMessage({group:"ERROR",operation:"LOCATION",data:"Location access disabled."})}function requestCallback(err,data){logTimeElapsed.call(this,timeLookup,"Finding nearest stations took %TIME%.");var stations=data.stations;var responseData=[];responseData.push(stations.length);stations.forEach(function(station){responseData.push(station.station_code);responseData.push(station.name)});this.pebble.sendAppMessage({group:"TRAIN",operation:"STATIONS",data:responseData.join("|")})}}function opTrainDepartures(data){if(this.analytics){this.analytics.trackEvent("train","departures-"+data)}var code=data;var requestData={api_key:this.transportApi.apiKey,app_id:this.transportApi.appId,limit:10};this.http.get("http://transportapi.com/v3/uk/train/station/"+code+"/live.json",requestData,function(err,data){if(err){switch(err.message){case"NOT_CONNECTED":this.pebble.sendAppMessage({group:"ERROR",operation:"HTTP",data:"Not online."});return;default:this.pebble.sendAppMessage({group:"ERROR",operation:"HTTP",data:"Unknown error."});return}}var departures=data.departures.all;var responseData=[];responseData.push(departures.length);departures.forEach(function(departure){responseData.push(departure.destination_name);responseData.push(departure.expected_departure_time)});this.pebble.sendAppMessage({group:"TRAIN",operation:"DEPARTURES",data:responseData.join("|")})}.bind(this))}function logTimeElapsed(start,message){var now=new Date;var totalMs=now.getTime()-start.getTime();if(this.debug){console.log(message.replace("%TIME%",totalMs+"ms"))}}};Train.prototype.init=function(){this.pebble.addEventListener("appmessage",this.onPebbleAppMessage.bind(this))};(function(){var ga;Pebble.addEventListener("ready",function(){ga=new Analytics("UA-48246810-1","UK Transport",AppInfo.versionLabel);train.init();tube.init();bus.init()});var tube=new Tube({pebble:Pebble,http:http,ga:ga,debug:true,version:AppInfo.versionLabel});var train=new Train({pebble:Pebble,http:http,ga:ga,location:navigator.geolocation,debug:true,transportApi:Config.transportApi,version:AppInfo.versionLabel});var bus=new Bus({pebble:Pebble,http:http,ga:ga,location:navigator.geolocation,debug:true,transportApi:Config.transportApi,version:AppInfo.versionLabel})})();